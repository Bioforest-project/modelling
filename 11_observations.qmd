```{r setup}
#| message: false
#| include: false
library(tidyverse)
library(knitr)
library(googlesheets4)
```

# Observations {.unnumbered}

Data exploration.

```{r data}
#| message: false
#| warning: false
#| eval: false
metadata <- read_sheet("https://docs.google.com/spreadsheets/d/1fq2owxMBLBwwibcdw2uQQFxnIhsMbaH4Qcj_xUwVvSQ/edit?gid=0#gid=0", col_types = "c") %>% # nolint
  rename_all(tolower) %>%
  select(site, plot, treatment, year_of_harvest) %>%
  separate(year_of_harvest, "year_of_harvest") %>%
  mutate(year_of_harvest = as.numeric(year_of_harvest)) %>%
  rename(harvest_year = year_of_harvest) %>%
  mutate(treatment = ifelse(
    treatment %in% c("control", "Control", "Natural_Forest"),
    "control", "logged"
  )) %>%
  group_by(site) %>%
  mutate(harvest_year_min = min(harvest_year, na.rm = TRUE)) %>%
  mutate(harvest_year = ifelse(site == "Paracou", 1986, harvest_year)) %>%
  mutate(harvest_year_min = ifelse(site == "Paracou", 1986, harvest_year_min))
data <- read_csv("data/raw_data/aggregated_data.csv") %>%
  rename_all(tolower) %>%
  left_join(read_tsv("data/raw_data/environment.tsv") %>%
    gather(env, env_value, -site, -plot)) %>%
  left_join(read_csv("data/raw_data/plot_area.csv") %>%
    rename_all(tolower) %>%
    select(site, plot, plotarea) %>%
    unique()) %>%
  left_join(metadata) %>%
  filter(!(site %in% c("Peteco", "Bafog", "Tene", "Montagne_Tortue"))) %>%
  filter(!(site == "Kabo" & year < 1980)) %>%
  mutate(rel_year = ifelse(treatment == "control",
    year - harvest_year_min,
    year - harvest_year
  ))
write_tsv(data, "data/derived_data/data.tsv")
```

```{r fig1}
#| message: false
#| warning: false
#| fig-cap: "Dummy figure 1 - traj."
read_tsv("data/derived_data/data.tsv") %>%
  ggplot(aes(year, value, group = paste(site, plot))) +
  geom_line() +
  theme_bw() +
  facet_wrap(~variable, scales = "free_y") +
  theme(
    axis.title = element_blank(),
    strip.text = element_text(size = 6)
  )
```

```{r fig2}
#| message: false
#| warning: false
#| fig-cap: "Dummy figure 2 - env."
read_tsv("data/derived_data/data.tsv") %>%
  filter(variable == "agb", env == "cwd") %>%
  na.omit() %>%
  ggplot(aes(year, value, group = paste(site, plot), col = env_value)) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_c("Climate\nwater\ndeficit\n[ mm ]") +
  xlab("") +
  ylab(expression("AGB [" ~ Mg ~ ha^{
    -1
  } ~ "]"))
```

```{r figs_out}
#| eval: false
make_fig <- function(var) {
  g <- read_tsv("data/derived_data/data.tsv") %>%
    filter(variable == var) %>%
    ggplot(aes(year, value, group = paste(site, plot), col = treatment)) +
    geom_line() +
    theme_bw() +
    xlab("") +
    ylab("") +
    facet_wrap(~site, scales = "free") +
    geom_vline(aes(xintercept = harvest_year)) +
    theme(legend.position = "bottom") +
    ggtitle(var)
  ggsave(plot = g, filename = paste0("figures/obs/", var, ".png"))
}
unique(read_tsv("data/derived_data/data.tsv")$variable) %>%
  lapply(make_fig)
```

```{r fig3}
#| message: false
#| warning: false
#| fig-cap: "Dummy figure 3 - treatment."
read_tsv("data/derived_data/data.tsv") %>%
  filter(variable == "agb_mort") %>%
  ggplot(aes(year, log(value), group = paste(site, plot), col = treatment)) +
  geom_line() +
  theme_bw() +
  xlab("") +
  ylab(expression("AGB [" ~ Mg ~ ha^{
    -1
  } ~ "]")) +
  facet_wrap(~site, scales = "free") +
  geom_vline(aes(xintercept = harvest_year)) +
  theme(legend.position = "bottom")
```
