```{r set}
#| message: false
#| include: false
library(tidyverse)
library(knitr)
library(cmdstanr)
library(bayesplot)
library(loo)
```

# Models {.unnumbered}

To do:

-   Add schemes of LTP & STP trajs with pars on it.
-   We need use random effect for control plots (plotoldnum).

## LTP

Long term process only model:

$$
\begin{align}
\mu_{rec} = \theta_{0,p} + (\theta_{\infty,s} - \theta_{0,p}) \times LTP \\
LTP = 1 - e^{-\lambda_p \times time}
\end{align}
$$

```{r ltp_proj}
#| warning: false
#| message: false
#| fig-cap: "LTP proj with pars."
ltp <- function(time, dist, thetainf, lambda) {
  theta0 <- thetainf * dist
  ltp <- 1 - exp(-lambda * time)
  return(theta0 + (thetainf - theta0) * (ltp))
}
data.frame(time = seq(0.1, 50, length.out = 100)) %>%
  mutate(y_ltp = ltp(time, dist = 0.5, thetainf = 20, lambda = 0.05)) %>%
  bind_rows(data.frame(time = 0, y_stp = 20, y_ltp = 20)) %>%
  ggplot(aes(time)) +
  geom_line(aes(y = y_ltp)) +
  theme_bw() +
  annotate("text", x = 52, y = 19.5, label = "theta[Inf]",
           col = "#9ea1d4", parse = TRUE, size = 5) +
  annotate("text", x = 20, y = 15, label = "lambda",
           col = "#a8d2d1", parse = TRUE, size = 5) +
  annotate("text", x = -4, y = 15, label = "dist",
           col = "#fc8a8a", parse = TRUE, size = 5) +
  theme(axis.title = element_blank()) +
  geom_segment(aes(x = -2, y = 10, xend = -2, yend = 20),
               arrow = arrow(length = unit(0.2, "cm")), col = "#fc8a8a") +
  geom_segment(aes(x = -2, y = 20, xend = -2, yend = 10),
               arrow = arrow(length = unit(0.2, "cm")), col = "#fc8a8a")
```

## STP

Long term and short term processes model based on disturbance index $dist$:

$$
\begin{align}
\mu_{rec} = \theta_{0,p} + (\theta_{\infty,s} - \theta_{0,p}) \times (LTP+STP) \\
LTP = 1 - e^{-\lambda_p \times time} \\
STP = \delta_p \times (\frac{time}{\tau_s} \times e^{1-\frac{time}{\tau_s}})^2 \\
\theta_{0,p} = \theta_{\infty,s} \times dist_p
\end{align}
$$

```{r stp_proj}
#| warning: false
#| message: false
#| fig-cap: "STP proj with pars."
stp <- function(time, dist, thetainf, lambda, tau, delta) {
  theta0 <- thetainf * dist
  ltp <- 1 - exp(-lambda * time)
  stp <- delta * (time / tau * exp(1 - time / tau))^2
  return(theta0 + (thetainf - theta0) * (ltp + stp))
}
data.frame(time = seq(0.1, 50, length.out = 100)) %>%
  mutate(y_stp = stp(time, dist = 0.5, thetainf = 20, lambda = 0.05,
                     tau = 5, delta = 1)) %>%
  mutate(y_ltp = ltp(time, dist = 0.5, thetainf = 20, lambda = 0.05)) %>%
  bind_rows(data.frame(time = 0, y_stp = 20, y_ltp = 20)) %>%
  ggplot(aes(time)) +
  geom_line(aes(y = y_ltp), col = "grey") +
  geom_line(aes(y = y_stp)) +
  theme_bw() +
  annotate("text", x = 52, y = 19.5, label = "theta[Inf]",
           col = "#9ea1d4", parse = TRUE, size = 5) +
  annotate("text", x = 20, y = 15, label = "lambda",
           col = "#a8d2d1", parse = TRUE, size = 5) +
  annotate("text", x = -4, y = 15, label = "dist",
           col = "#fc8a8a", parse = TRUE, size = 5) +
  theme(axis.title = element_blank()) +
  geom_segment(aes(x = -2, y = 10, xend = -2, yend = 20),
               arrow = arrow(length = unit(0.2, "cm")), col = "#fc8a8a") +
  geom_segment(aes(x = -2, y = 20, xend = -2, yend = 10),
               arrow = arrow(length = unit(0.2, "cm")), col = "#fc8a8a") +
  annotate("text", x = 6, y = 11.3, label = "tau",
           col = "#f2e5a9", parse = TRUE, size = 5) +
  annotate("text", x = 5, y = 17.5, label = "delta",
           col = "#a7d6ac", parse = TRUE, size = 5) +
  geom_segment(aes(x = 6, y = 13, xend = 6, yend = 22),
               arrow = arrow(length = unit(0.2, "cm")), col = "#a7d6ac") +
  geom_segment(aes(x = 6, y = 22, xend = 6, yend = 13),
               arrow = arrow(length = unit(0.2, "cm")), col = "#a7d6ac") +
  geom_segment(aes(x = 6, y = 11, xend = 6, yend = 10),
               arrow = arrow(length = unit(0.2, "cm")), col = "#f2e5a9") +
  theme(axis.title = element_blank())
```

Choices:

-   Using the log of y and a normal distribution centred on log(mu)
-   Cauchy hyperdist
-   Forced dist_p\<1
-   Bounds of theta
-   Free tau
-   Free delta

⚠️ Hump is mathematically opposed to the sign of dist_p-1.

## Old

### STP sum

`models/stp_sum.stan`

$$
\begin{align}
\mu_{rec} = \theta_{0,p} + (\theta_{\infty,s} - \theta_{0,p}) \times (LTP+STP) \\
LTP = 1 - e^{-\lambda_p \times time} \\
STP = \delta_p \times (\frac{time}{\tau_s} \times e^{1-\frac{time}{\tau_s}})^2 \\
\theta_{0,p} = \theta_{\infty,s} \times dist_p
\end{align}
$$

### STP lognormal

`models/stp.stan`

$$
\begin{align}
\mu_{rec} = \theta_{0,p} + (\theta_{\infty,s} - \theta_{0,p}) \times (LTP+STP) \\
LTP = 1 - e^{-\lambda_p \times time} \\
STP = \delta_p \times (\frac{time}{\tau_s} \times e^{1-\frac{time}{\tau_s}})^2 \\
\theta_{0,p} = \theta_{\infty,s} \times dist_p
\end{align}
$$

### STP correlated

`models/stp_cor.stan`

Imposed variance-covariance matrix on dist_p and delta_p.

$$
\begin{align}
\mu_{rec} = \theta_{0,p} + (\theta_{\infty,s} - \theta_{0,p}) \times (LTP+STP) \\
LTP = 1 - e^{-\lambda_p \times time} \\
STP = \delta_p \times (\frac{time}{\tau_s} \times e^{1-\frac{time}{\tau_s}})^2 \\
\theta_{0,p} = \theta_{\infty,s} \times dist_p
\end{align}
$$

## Parrallel

`dummy_par.stan`
