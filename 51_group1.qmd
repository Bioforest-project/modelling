```{r set}
#| message: false
#| include: false
library(tidyverse)
library(knitr)
```

# Group 1 {.unnumbered}

Group 1 on **LoggingDiversity** focus on the **effects of logging disturbance on tropical forest diversity - a global assessment** with the following question: What is the effect of logging intensity on biodiversity, and how does it change through time? We started from two hypotheses:

-   **H1**: tree diversity long-term response increases through time to a maximum value, after which it then declines in late succession
-   **H2**: tree diversity also shows a non-linear response to increased intensity of logging: lightly logged forests show a transient increase in tree diversity, but more intensively logged forests show a strong negative effect on diversity

We will thus mainly work with diversity trajectories (genus & functional) bump characterized through bump time $\tau'$ & bump intensity $\delta$ in the model and link it with forest structure (BA, AGB, or stem) disturbance index $dist_{ba}$.

```{r}
#| message: false
#| warning: false
site_pars <- read_tsv("outputs/parameters.tsv") %>%
  filter(level == "site") %>%
  select(attribute, parameter, site, median) %>%
  pivot_wider(names_from = parameter, values_from = median)
pars <- read_tsv("outputs/parameters.tsv") %>%
  filter(level == "plot") %>%
  select(attribute, parameter, site, plot, median) %>%
  pivot_wider(names_from = parameter, values_from = median) %>%
  left_join(site_pars) %>%
  mutate(deltap = (delta * thetaInf) / (thetaInf - (thetaInf * dist)))
```

## H1 - Diversity & time

> **H1**: tree diversity long-term response increases through time to a maximum value, after which it then declines in late succession

**Kibale and Mbaiki have been removed has they don't have short term data. But, do we trust Malinau's bump with solely three recent inventories?** Genus diversity are good and could be trusted even if a few outlier sites delta might be underestimated, but is not a data issue? However, functional diversity trajectory is still not good enough needing either model or data tweaking. **Genus diversity delta distribution are bimodal and should be explored, e.g. I don't trust low delta in Paracou that are the sites lacking genus identification. Also how much plot delta max per site is linked to tau site being itself linked to the duration of inventories?**

```{r tau}
#| message: false
#| warning: false
read_tsv("outputs/parameters.tsv") %>%
  filter(level == "site") %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(type == "diversity" & parameter == "tau") %>%
  mutate_at(c("median", "sd", "q5", "q95"), ~ . + 3) %>%
  ggplot(aes(x = site, col = continent)) +
  geom_point(aes(y = median)) +
  geom_segment(aes(y = median - sd, yend = median + sd)) +
  geom_segment(aes(y = q5, yend = q95), size = .1) +
  facet_wrap(~attribute) +
  coord_flip() +
  theme_bw() +
  ylab(expression(tau ~ "[ year ]")) +
  xlab("") +
  scale_color_discrete("") +
  ggtitle(expression(Site ~ tau)) +
  theme(legend.position = "bottom")
```

```{r delta}
#| message: false
#| warning: false
read_tsv("outputs/parameters.tsv") %>%
  filter(level == "plot") %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(type == "diversity" & parameter == "delta") %>%
  ggplot(aes(x = 100 * median, y = site, fill = continent)) +
  ggridges::geom_density_ridges() +
  facet_wrap(~attribute) +
  theme_bw() +
  xlab(expression(delta ~ "[ % ]")) +
  ylab("") +
  scale_fill_discrete("") +
  ggtitle(expression(Plot ~ delta)) +
  theme(legend.position = "bottom") +
  scale_x_log10()
```

```{r delta_tau}
#| message: false
#| warning: false
read_tsv("outputs/parameters.tsv") %>%
  filter(
    type == "diversity",
    parameter %in% c("delta", "tau")
  ) %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  select(attribute, parameter, site, median) %>%
  pivot_wider(names_from = parameter, values_from = median) %>%
  unnest(tau, delta) %>%
  ggplot(aes(tau, delta * 100, col = site)) +
  geom_point() +
  theme_bw() +
  scale_y_log10() +
  ylab(expression(delta ~ "[ % ]")) +
  xlab(expression(tau ~ "[ year ]")) +
  scale_color_discrete("") +
  ggtitle(expression(Plot ~ delta ~ "~" ~ Site ~ tau)) +
  facet_wrap(~attribute) +
  scale_x_sqrt()
```

## H2 - Diversity & intensity

> **H2**: tree diversity also shows a non-linear response to increased intensity of logging: lightly logged forests show a transient increase in tree diversity, but more intensively logged forests show a strong negative effect on diversity

```{r delta_dist_ba}
#| message: false
#| warning: false
#| fig-width: 9
#| fig-height: 7
dist_p <- read_tsv("outputs/parameters.tsv") %>%
  filter(parameter == "dist", attribute == "ba") %>%
  select(site, plot, median, sd, q5, q95) %>%
  unique() %>%
  rename_at(c("median", "sd", "q5", "q95"), ~ paste0(., "_dist_ba"))
read_tsv("outputs/parameters.tsv") %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(parameter == "delta", type == "diversity") %>%
  left_join(dist_p) %>%
  ggplot(aes((1 - median_dist_ba) * 100, median * 100, col = site)) +
  geom_smooth(method = "lm", se = FALSE, col = "black", aes(group = NA)) +
  geom_point() +
  facet_wrap(~attribute, scales = "free_y") +
  scale_y_log10() +
  theme_bw() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "[ % ]")) +
  scale_color_discrete("") +
  ggtitle(expression(Plot ~ delta ~ "~" ~ dist[BA])) +
  ggpubr::stat_cor(aes(group = NA))
```

```{r delta_dist_ba_plot}
#| message: false
#| warning: false
#| fig-width: 9
#| fig-height: 7
read_tsv("outputs/parameters.tsv") %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(parameter == "delta", type == "diversity") %>%
  filter(attribute == "diversity_q1_gen") %>%
  left_join(dist_p) %>%
  ggplot(aes((1 - median_dist_ba) * 100, median * 100, col = site)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point() +
  facet_wrap(~site, scales = "free_y") +
  scale_y_log10() +
  theme_bw() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "[ % ]")) +
  scale_color_discrete("") +
  theme(legend.position = "bottom") +
  ggtitle(expression("Genus diversity:" ~ Plot ~ delta ~ "~" ~ dist[BA]))
```

```{r}
#| message: false
#| warning: false
read_tsv("outputs/parameters.tsv") %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(parameter == "delta", type == "diversity") %>%
  filter(attribute == "diversity_q1_gen") %>%
  left_join(dist_p) %>%
  filter(median >= 0.2, median <= 0.5) %>%
  ggplot(aes((1 - median_dist_ba) * 100, median * 100, col = site)) +
  geom_smooth(method = "lm", se = FALSE, col = "black", aes(group = NA)) +
  geom_point() +
  facet_wrap(~attribute, scales = "free_y") +
  scale_y_log10() +
  theme_bw() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "[ % ]")) +
  scale_color_discrete("") +
  ggtitle(expression("Genus diversity:" ~ Plot ~ delta ~ "~"
                     ~ dist[BA] ~ "| dist in [20%, 50%]")) +
  ggpubr::stat_cor(aes(group = NA))
```

```{r delta_dist_gen}
#| message: false
#| warning: false
dist_p <- read_tsv("outputs/parameters.tsv") %>%
  filter(parameter == "dist", attribute == "diversity_q1_gen") %>%
  select(site, plot, median, sd, q5, q95) %>%
  unique() %>%
  rename_at(c("median", "sd", "q5", "q95"), ~ paste0(., "_dist_ba"))
rel_year_max <- read_tsv("data/derived_data/data_rec.tsv") %>%
  group_by(site) %>%
  summarise(rel_year_max = max(rel_year))
read_tsv("outputs/parameters.tsv") %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(parameter == "delta", type == "diversity") %>%
  filter(attribute == "diversity_q1_gen") %>%
  left_join(dist_p) %>%
  left_join(rel_year_max) %>%
  ggplot(aes((1 - median_dist_ba) * 100, median * 100, col = rel_year_max)) +
  geom_smooth(method = "lm", se = FALSE, col = "black", aes(group = NA)) +
  geom_point() +
  facet_wrap(~attribute, scales = "free_y") +
  scale_y_log10() +
  theme_bw() +
  xlab(expression(dist[Genus] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "[ % ]")) +
  ggtitle(expression(Plot ~ delta ~ "~" ~ dist[genus])) +
  ggpubr::stat_cor(aes(group = NA)) +
  scale_color_viridis_c()
```

```{r y15_dist}
#| message: false
#| warning: false
library(cmdstanr)
dist_p <- read_tsv("outputs/parameters.tsv") %>%
  filter(parameter == "dist", attribute == "ba") %>%
  select(site, plot, median, sd, q5, q95) %>%
  unique() %>%
  rename_at(c("median", "sd", "q5", "q95"), ~ paste0(., "_dist_ba"))
data <- read_tsv("data/derived_data/data_rec.tsv") %>%
  filter(variable == "diversity_q1_gen") %>%
  select(site, plot, plotnum_rec) %>%
  unique()
theta <- read_tsv("outputs/parameters.tsv") %>%
  filter(parameter == "thetaInf", attribute == "diversity_q1_gen") %>%
  select(site, mean) %>%
  rename(theta = mean)
fit <- as_cmdstan_fit(list.files("chains/diversity_q1_gen/stp/",
                                 full.names = TRUE))
y15 <- fit$summary("y_pred", "median") %>%
  separate(variable,
    c("y", "pred", "rel_year", "plotnum_rec"),
    convert = TRUE
  ) %>%
  select(-y, -pred) %>%
  rename(y = median) %>%
  mutate(rel_year = rel_year + 3) %>%
  filter(rel_year == 15) %>%
  left_join(data) %>%
  left_join(dist_p) %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  left_join(theta) %>%
  mutate(y_rel = y / theta)
y15 %>%
  ggplot(aes((1 - median_dist_ba) * 100, y_rel)) +
  geom_smooth(method = "lm", col = "black") +
  geom_point(aes(col = site)) +
  theme_bw() +
  ggpubr::stat_cor() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(y[pred ~ t == 15] / theta[Inf])) +
  ggtitle(expression(Plot ~ y[pred ~ t == 15] / theta[Inf] ~ "~" ~ dist[BA]))
```

```{r y15_dist_site}
#| message: false
#| warning: false
y15 %>%
  ggplot(aes((1 - median_dist_ba) * 100, y_rel)) +
  geom_smooth(method = "lm", col = "black") +
  geom_point() +
  theme_bw() +
  ggpubr::stat_cor() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(y[pred ~ t == 15] / theta[Inf])) +
  ggtitle(expression(Plot ~ y[pred ~ t == 15] / theta[Inf] ~ "~" ~ dist[BA])) +
  facet_wrap(~site, scales = "free")
```

## H2 - Diversity & intensity with $\delta'$

> **We will use** $\delta'$ **as** $\delta'=\frac{\delta\times\theta_{\infty}}{\theta_{\infty}-\theta_{0}}$ **to solve the issue of relativity pointed by Camille but in a near future we should re-express and re-fit the model as** $\theta_{0} + (\theta_{\infty}-\theta_{0})\times LTP + \theta_{\infty} \times STP$**.**

```{r}
#| message: false
#| warning: false
pars %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(attribute == "diversity_q1_gen") %>%
  left_join(dist_p) %>%
  ggplot(aes((1 - median_dist_ba) * 100, deltap, col = site)) +
  geom_smooth(method = "lm", se = FALSE, col = "black", aes(group = NA)) +
  geom_point() +
  facet_wrap(~attribute, scales = "free_y") +
  theme_bw() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "'" ~ "[ % ]")) +
  scale_color_discrete("") +
  ggpubr::stat_cor(aes(group = NA))
```

```{r}
#| message: false
#| warning: false
pars %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(attribute == "diversity_q1_gen") %>%
  left_join(dist_p) %>%
  ggplot(aes((1 - median_dist_ba) * 100, deltap, col = site)) +
  geom_smooth(method = "lm", se = FALSE, col = "black", aes(group = NA)) +
  geom_point() +
  facet_wrap(~attribute, scales = "free_y") +
  theme_bw() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "'" ~ "[ % ]")) +
  scale_color_discrete("") +
  ggpubr::stat_cor(aes(group = NA)) +
  scale_y_log10()
```

```{r}
#| message: false
#| warning: false
pars %>%
  filter(!(site %in% c("Kibale", "Uppangala"))) %>%
  filter(attribute == "diversity_q1_gen") %>%
  left_join(dist_p) %>%
  ggplot(aes((1 - median_dist_ba) * 100, deltap)) +
  geom_smooth(method = "lm", se = FALSE, col = "black", aes(group = NA)) +
  geom_point() +
  facet_wrap(~attribute, scales = "free_y") +
  theme_bw() +
  xlab(expression(dist[BA] ~ "[ % lost ]")) +
  ylab(expression(delta ~ "'" ~ "[ % ]")) +
  scale_color_discrete("") +
  ggtitle(expression(Plot ~ delta ~ "~" ~ dist[BA])) +
  ggpubr::stat_cor(aes(group = NA)) +
  facet_wrap(~site) +
  scale_y_log10()
```
