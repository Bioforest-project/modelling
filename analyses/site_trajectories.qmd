---
title: "Site trajectory"
format:
  pdf:
    number-sections: false
params:
  site: Mbaiki
execute:
  echo: false      
---

```{r set}
#| include: false
library(tidyverse)
library(cmdstanr)
library(knitr)
options(knitr.kable.NA = "")
list.files("../r", full.names = TRUE, pattern = ".R") %>%
  lapply(source)
```

```{r functions}
#| include: false
list.files("../r", full.names = TRUE, pattern = ".R") %>%
  lapply(source)
prep_data_site <- function(
    var,
    sit) {
  data <- read_tsv("../data/derived_data/data.tsv") %>%
    filter(variable == var) %>%
    {
      if (var == "agb") filter(., site != "Kibale") else .
    } %>%
    # if conditions needs to be added for some variables
    unique() %>%
    rename(stem = value) %>%
    select(-env, -env_value, -variable) %>%
    unique() %>%
    filter(!is.infinite(harvest_year_min)) %>%
    mutate(sitenum = as.numeric(as.factor(site)))
  data_rec <- data %>%
    filter(treatment == "logged", rel_year > 2) %>%
    mutate(plotnum = as.numeric(as.factor(paste0(site, "_", plot)))) %>%
    filter(site == sit)
  data_old <- data %>%
    filter(treatment == "control") %>%
    filter(site == sit)
  data_pre <- data %>%
    filter(rel_year <= 0) %>%
    filter(site == sit)
  return(list(
    var = var,
    data_rec = data_rec,
    data_old = data_old,
    data_pre = data_pre
  ))
}

site_fig <- function(
    var,
    site) {
  print(var) # debug
  data <- prep_data_site(var, site)
  if (var == "agb") {
    lab <- expression("AGB [ t" ~ ha^{
      -1
    } ~ "]")
  }
  if (var == "ba") {
    lab <- expression("BA [" ~ m^2 ~ m^{
      -2
    } ~ "]")
  }
  if (var == "nstem") {
    lab <- expression("Stem [ trees" ~ ha^{
      -1
    } ~ "]")
  }
  if (var == "gini") {
    lab <- expression("Gini")
  }
  if (var == "diversity_q1_gen") {
    lab <- expression("Genus diversity q=1")
  }
  if (var == "FDiv") {
    lab <- expression("FDiv")
  }
  if (var == "SLA_cwm_ba") {
    lab <- expression("SLA [" ~ mm^2 ~ mg^{
      -1
    } ~ "]")
  }
  if (var == "WD_cwm_ba") {
    lab <- expression("WD [ g" ~ cm^{
      -3
    } ~ "]")
  }
  if (var == "hmax_cwm_ba") {
    lab <- expression("hmax [" ~ m ~ "]")
  }
  path <- file.path("..", "chains", var, "stp")
  fit_stp <- as_cmdstan_fit(list.files(path, full.names = TRUE))
  g <- stp_fig(
    data_rec = data$data_rec,
    data_pre = data$data_pre,
    data_old = data$data_old,
    fit_stp, lab
  )
  return(g)
}
```

```{r prep_figs}
#| include: false
vars <- c(
  "agb", "ba", "nstem", "gini", "diversity_q1_gen", "FDiv",
  "SLA_cwm_ba", "WD_cwm_ba", "hmax_cwm_ba"
)
figs <- lapply(vars, site_fig, params$site)
names(figs) <- vars
```

## Site

```{r site}
#| message: false
read_tsv("../data/derived_data/data.tsv") %>%
  filter(site == params$site) %>%
  group_by(site, plot, treatment, harvest_year) %>%
  summarise(year_min = min(year), year_max = max(year)) %>%
  arrange(plot) %>%
  kable(col.names = c(
    "Site", "Plot", "Treatment", "Harvest year",
    "First inventory", "Last inventory"
  ))
```

## Aboveground Biomass - AGB

```{r agb}
#| message: false
figs$agb +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Basal area - BA

```{r ba}
#| message: false
figs$ba +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Stem density

```{r nstem}
#| message: false
figs$nstem +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Gini index

```{r gini}
#| message: false
figs$gini +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Genus diversity

Using the Hill number of order 1 with genus richness per hectare for a coverage of 80%.

```{r diversity_q1_gen}
#| message: false
figs$diversity_q1_gen +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Functional diversity - FDiv

FDiv indicce (ref).

```{r FDiv}
#| message: false
figs$FDiv +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Wood Density - WD

Community Weighted Mean (CWM) of Wood Density (WD) per Basal Area (BA).

```{r WD_cwm_ba}
#| message: false
figs$WD_cwm_ba +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Specific Leaf Area - SLA

Community Weighted Mean (CWM) of Specific Leaf Area (SLA) per Basal Area (BA).

```{r SLA_cwm_ba}
#| message: false
figs$SLA_cwm_ba +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```

## Asymptotic height - hmax

Community Weighted Mean (CWM) of asymptotic height hmax per Basal Area (BA).

```{r hmax_cwm_ba}
#| message: false
figs$hmax_cwm_ba +
  scale_color_discrete("Plot") +
  theme(legend.position = "right")
```
